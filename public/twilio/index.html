<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style type="text/css">
    body {
      background-color: #f5f5f5;
      margin: 0;
      font-size: 16px;
      font-family: sans-serif;
    }

    .ticket {
      margin: 24px;
      color: #444;
      background-color: #fff;
      border-radius: 6px;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      position: relative;
    }

    .ticket-row {
      flex: 1 0 100%;
      display: flex;
      align-items: center;
    }

    .ticket-id {
      color: #888;
      font-weight: bold;
      margin-right: 1rem;
    }

    .ticket-status {
      font-size: 0.8rem;
      padding: 0.125rem 0.5rem;
      border-radius: 1rem;
      color: #fff;
    }
    .ticket-status--complete {
      color: #d1f7c4;
      background-color: #338a17;
    }

    .ticket-permalink {
      color: #555;
      font-size: 0.8rem;
      margin-left: auto;
    }

    .ticket-name {
      margin: 0.5rem 0;
    }
    .ticket-nearestIntersection {
      margin: 0;
      font-size: 0.8rem;
      opacity: 0.85;
    }
    .ticket-phoneNumber {
      margin-bottom: 0;
      opacity: 0.75;
    }

    .ticket-createdAt {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    #loading {
      display: none;
      padding: 1rem;
    }
    #loading.visible {
      display: block;
    }
  </style>
</head>
<body>
  <template id="template">
    <div class="ticket">
      <div class="ticket-row">
        <div class="ticket-id">[[ticketID]]</div>
        <div class="ticket-status ticket-status--complete">[[status]]</div>
        <a class="ticket-permalink" href="https://airtable.com/tbljexnPd5eBpLilw/[[record ID]]" target="_blank">View in Airtable</a>
      </div>
      <div>
        <h3 class="ticket-name">[[requestName]]</h3>
        <p class="ticket-nearestIntersection">[[nearestIntersection]]</p>
        <h5 class="ticket-phoneNumber">[[phoneNumber]]</h5>
      </div>
      <div class="ticket-row">
        <div class="ticket-createdAt">[[dateCreated]]</div>
      </div>
    </div>
  </template>
  <div id="tickets">
    <div id="loading">Loading...</div>
  </div>
  <script type="text/javascript">
    const apiBase = 'https://us-central1-bedstuystrong-automation-a4b75.cloudfunctions.net';

    if (window === window.top) {
      window.location = 'https://bedstuystrong.com';
    } else {
      const template = document.getElementById('template');
      const ticketContainer = document.getElementById('tickets');
      const loadingIndicator = document.getElementById('loading');
      const params = new URLSearchParams(window.location.search);
      const apiUrl = `${apiBase}/api-findTicketsByPhoneNumber`;

      if (params.get('phoneNumber')) {
        loadingIndicator.classList.add('visible');

        fetch(`${apiUrl}?phoneNumber=${encodeURIComponent(params.get('phoneNumber'))}`).then(response => {
          if (!response.ok) {
            throw new Error(response.statusText);
          }
          return response.json();
        }).then((tickets) => {

          const markup = tickets.map((ticket) => {
            return template.innerHTML.replace(/\[\[([a-zA-Z0-9\s]+)\]\]/g, (match, key) => {
              let value = ticket[key];
              if (key === 'dateCreated') {
                value = new Date(value).toLocaleString('en-US').split(',')[0];
              }
              return value;
            });
          }).join('\n');

          const newTemplate = document.createElement('template');
          newTemplate.innerHTML = markup;
          ticketContainer.appendChild(newTemplate.content);
          loadingIndicator.classList.remove('visible');
        });
      }
    }
</script>
</body>

</html>


